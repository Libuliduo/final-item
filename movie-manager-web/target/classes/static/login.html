<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <link rel="icon" href="images/videoPlay.png" type="image/x-icon">

    <link rel="stylesheet" href="./element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="css/style.css">

    <script src="js/vue.js"></script>
    <script src="/js/axios-0.18.0.js"></script>
    <script src="element-ui/lib/index.js"></script>

    <style>
        #login-register-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: url("images/trees_lake.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
    <link rel="stylesheet" href="css/loginStyle.css">
</head>
<body>
<div id="login-register-container">
    <!-- 1. 注册框 -->
    <div class="login-register-item" v-if="isRegister && !isResetPassword">
        <svg fill="#FFFFFF" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="100px" height="100px">
            <path d="M 29.625 2 C 22.394531 2 18.871094 5.601563 17.734375 9.75 C 16.769531 8.769531 15.304688 8 13.167969 8 C 9.601563 8 6 10.085938 6 14.75 C 6 16.617188 7.105469 18.375 8.632813 19.308594 C 7.363281 20.242188 6 21.710938 6 24 C 6 25.527344 6.460938 26.714844 7.109375 27.621094 C 7.902344 27.226563 8.796875 27 9.75 27 C 10.582031 27 11.417969 27.136719 12.21875 27.402344 C 12.953125 27.136719 13.726563 27 14.5 27 C 15.359375 27 16.210938 27.160156 17 27.472656 C 17.789063 27.160156 18.640625 27 19.5 27 C 20.359375 27 21.210938 27.160156 22 27.472656 C 22.789063 27.160156 23.640625 27 24.5 27 C 25.359375 27 26.210938 27.160156 27 27.472656 C 27.789063 27.160156 28.640625 27 29.5 27 C 30.359375 27 31.210938 27.160156 32 27.472656 C 32.789063 27.160156 33.640625 27 34.5 27 C 35.273438 27 36.046875 27.136719 36.78125 27.402344 C 37.578125 27.136719 38.417969 27 39.25 27 C 40.5625 27 41.769531 27.429688 42.738281 28.140625 C 42.816406 28.054688 42.910156 27.9375 43.019531 27.777344 C 43.996094 26.351563 44 24.882813 44 24.25 C 44 21.117188 42.742188 19.292969 41.308594 18.464844 C 41.921875 16.59375 42 14.109375 42 13 C 42 6.316406 37.144531 2 29.625 2 Z M 17.5 16 C 18.882813 16 20 17.117188 20 18.5 C 20 19.882813 18.882813 21 17.5 21 C 16.117188 21 15 19.882813 15 18.5 C 15 17.117188 16.117188 16 17.5 16 Z M 33.5 16 C 34.882813 16 36 17.117188 36 18.5 C 36 19.882813 34.882813 21 33.5 21 C 32.117188 21 31 19.882813 31 18.5 C 31 17.117188 32.117188 16 33.5 16 Z M 18 17 C 17.449219 17 17 17.449219 17 18 C 17 18.550781 17.449219 19 18 19 C 18.550781 19 19 18.550781 19 18 C 19 17.449219 18.550781 17 18 17 Z M 34 17 C 33.449219 17 33 17.449219 33 18 C 33 18.550781 33.449219 19 34 19 C 34.550781 19 35 18.550781 35 18 C 35 17.449219 34.550781 17 34 17 Z M 23 21 L 28 21 C 28.550781 21 29 21.449219 29 22 C 29 23.65625 27.65625 25 26 25 L 25 25 C 23.34375 25 22 23.65625 22 22 C 22 21.449219 22.449219 21 23 21 Z M 9.75 29 C 7.683594 29 6 30.570313 6 32.5 C 6 32.589844 6.011719 32.679688 6.035156 32.765625 L 10.035156 47.265625 C 10.15625 47.699219 10.550781 48 11 48 L 38 48 C 38.449219 48 38.84375 47.699219 38.964844 47.265625 L 42.964844 32.765625 C 42.988281 32.679688 43 32.589844 43 32.5 C 43 30.570313 41.316406 29 39.25 29 C 38.332031 29 37.476563 29.222656 36.75 29.566406 C 36.082031 29.214844 35.316406 29 34.5 29 C 33.582031 29 32.71875 29.257813 32 29.695313 C 31.28125 29.257813 30.417969 29 29.5 29 C 28.582031 29 27.71875 29.257813 27 29.695313 C 26.28125 29.257813 25.417969 29 24.5 29 C 23.582031 29 22.71875 29.257813 22 29.695313 C 21.28125 29.257813 20.417969 29 19.5 29 C 18.582031 29 17.71875 29.257813 17 29.695313 C 16.28125 29.257813 15.417969 29 14.5 29 C 13.683594 29 12.917969 29.214844 12.25 29.566406 C 11.523438 29.222656 10.667969 29 9.75 29 Z M 9.75 31 C 11.066406 31 11.890625 31.5625 12.15625 31.886719 L 14.695313 46 L 11.761719 46 L 8.007813 32.386719 C 8.078125 31.621094 8.847656 31 9.75 31 Z M 19.5 31 C 20.703125 31 21.742188 31.761719 22 32.625 C 21.992188 32.625 22.46875 46 22.46875 46 L 18.640625 46 L 17.152344 32.378906 C 17.492188 31.625 18.414063 31 19.5 31 Z M 29.5 31 C 30.59375 31 31.515625 31.628906 31.855469 32.390625 L 30.410156 46 L 26.53125 46 C 26.53125 46 27.007813 32.625 27 32.625 C 27.253906 31.761719 28.289063 31 29.5 31 Z M 39.25 31 C 40.152344 31 40.921875 31.621094 40.996094 32.386719 L 37.238281 46 L 34.304688 46 L 36.839844 31.886719 C 37.105469 31.5625 37.933594 31 39.25 31 Z"/>
        </svg>
        <div class="login-name">Popcorn影视</div>
        <!-- 账号输入框 -->
        <input class="login-register-input" type="email" v-model="email" placeholder="请输入邮箱*"/>
        <!-- 手机号输入框 -->
        <input class="login-register-input" type="tel" v-model="telephone" placeholder="请输入手机号"/>
        <!-- 密码输入框 -->
        <input class="login-register-input" type="password" v-model="password" placeholder="请设置密码"/>
        <!-- 验证码输入 + 按钮 -->
        <div class="code-wrapper">
            <input class="login-register-input code-input" type="text" v-model="code" placeholder="请输入验证码"/>
            <button @click="sendCode" class="get-code-btn" :disabled="isSendButton">{{ isSendButton ? countdown + '秒后重发'
                : '获取验证码' }}
            </button>
        </div>
        <!-- 注册按钮-->
        <button @click="register" class="auto-button" style="width: 70%; height: 50px; margin-top: 20px">注册</button>

        <div><a href="javascript:void(0)" @click="switchToLogin">已有账号?立即登录</a></div>
    </div>

    <!-- 2. 登录框 -->
    <div class="login-register-item" v-if="!isRegister && !isResetPassword">
        <!-- logo -->
        <svg fill="#FFFFFF" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="100px" height="100px">
            <path d="M 29.625 2 C 22.394531 2 18.871094 5.601563 17.734375 9.75 C 16.769531 8.769531 15.304688 8 13.167969 8 C 9.601563 8 6 10.085938 6 14.75 C 6 16.617188 7.105469 18.375 8.632813 19.308594 C 7.363281 20.242188 6 21.710938 6 24 C 6 25.527344 6.460938 26.714844 7.109375 27.621094 C 7.902344 27.226563 8.796875 27 9.75 27 C 10.582031 27 11.417969 27.136719 12.21875 27.402344 C 12.953125 27.136719 13.726563 27 14.5 27 C 15.359375 27 16.210938 27.160156 17 27.472656 C 17.789063 27.160156 18.640625 27 19.5 27 C 20.359375 27 21.210938 27.160156 22 27.472656 C 22.789063 27.160156 23.640625 27 24.5 27 C 25.359375 27 26.210938 27.160156 27 27.472656 C 27.789063 27.160156 28.640625 27 29.5 27 C 30.359375 27 31.210938 27.160156 32 27.472656 C 32.789063 27.160156 33.640625 27 34.5 27 C 35.273438 27 36.046875 27.136719 36.78125 27.402344 C 37.578125 27.136719 38.417969 27 39.25 27 C 40.5625 27 41.769531 27.429688 42.738281 28.140625 C 42.816406 28.054688 42.910156 27.9375 43.019531 27.777344 C 43.996094 26.351563 44 24.882813 44 24.25 C 44 21.117188 42.742188 19.292969 41.308594 18.464844 C 41.921875 16.59375 42 14.109375 42 13 C 42 6.316406 37.144531 2 29.625 2 Z M 17.5 16 C 18.882813 16 20 17.117188 20 18.5 C 20 19.882813 18.882813 21 17.5 21 C 16.117188 21 15 19.882813 15 18.5 C 15 17.117188 16.117188 16 17.5 16 Z M 33.5 16 C 34.882813 16 36 17.117188 36 18.5 C 36 19.882813 34.882813 21 33.5 21 C 32.117188 21 31 19.882813 31 18.5 C 31 17.117188 32.117188 16 33.5 16 Z M 18 17 C 17.449219 17 17 17.449219 17 18 C 17 18.550781 17.449219 19 18 19 C 18.550781 19 19 18.550781 19 18 C 19 17.449219 18.550781 17 18 17 Z M 34 17 C 33.449219 17 33 17.449219 33 18 C 33 18.550781 33.449219 19 34 19 C 34.550781 19 35 18.550781 35 18 C 35 17.449219 34.550781 17 34 17 Z M 23 21 L 28 21 C 28.550781 21 29 21.449219 29 22 C 29 23.65625 27.65625 25 26 25 L 25 25 C 23.34375 25 22 23.65625 22 22 C 22 21.449219 22.449219 21 23 21 Z M 9.75 29 C 7.683594 29 6 30.570313 6 32.5 C 6 32.589844 6.011719 32.679688 6.035156 32.765625 L 10.035156 47.265625 C 10.15625 47.699219 10.550781 48 11 48 L 38 48 C 38.449219 48 38.84375 47.699219 38.964844 47.265625 L 42.964844 32.765625 C 42.988281 32.679688 43 32.589844 43 32.5 C 43 30.570313 41.316406 29 39.25 29 C 38.332031 29 37.476563 29.222656 36.75 29.566406 C 36.082031 29.214844 35.316406 29 34.5 29 C 33.582031 29 32.71875 29.257813 32 29.695313 C 31.28125 29.257813 30.417969 29 29.5 29 C 28.582031 29 27.71875 29.257813 27 29.695313 C 26.28125 29.257813 25.417969 29 24.5 29 C 23.582031 29 22.71875 29.257813 22 29.695313 C 21.28125 29.257813 20.417969 29 19.5 29 C 18.582031 29 17.71875 29.257813 17 29.695313 C 16.28125 29.257813 15.417969 29 14.5 29 C 13.683594 29 12.917969 29.214844 12.25 29.566406 C 11.523438 29.222656 10.667969 29 9.75 29 Z M 9.75 31 C 11.066406 31 11.890625 31.5625 12.15625 31.886719 L 14.695313 46 L 11.761719 46 L 8.007813 32.386719 C 8.078125 31.621094 8.847656 31 9.75 31 Z M 19.5 31 C 20.703125 31 21.742188 31.761719 22 32.625 C 21.992188 32.625 22.46875 46 22.46875 46 L 18.640625 46 L 17.152344 32.378906 C 17.492188 31.625 18.414063 31 19.5 31 Z M 29.5 31 C 30.59375 31 31.515625 31.628906 31.855469 32.390625 L 30.410156 46 L 26.53125 46 C 26.53125 46 27.007813 32.625 27 32.625 C 27.253906 31.761719 28.289063 31 29.5 31 Z M 39.25 31 C 40.152344 31 40.921875 31.621094 40.996094 32.386719 L 37.238281 46 L 34.304688 46 L 36.839844 31.886719 C 37.105469 31.5625 37.933594 31 39.25 31 Z"/>
        </svg>
        <div class="login-name">Popcorn影视</div>

        <!-- 账号 密码输入框 -->
        <input class="login-register-input" type="text" v-model="account" placeholder="请输入账号"/>
        <input class="login-register-input" type="password" v-model="loginPassword" placeholder="请输入密码"/>
        <div class="reset-wrapper"><a href="javascript:void(0)" @click="switchToReset">忘记密码？</a></div>

        <!-- 登录按钮-->
        <button @click="login" class="auto-button" style="width: 70%; height: 50px; margin-top: 20px">登录</button>
        <div><a href="javascript:void(0)" @click="switchToRegister">没有账号?点击注册</a></div>
    </div>

    <!-- 3. 找回密码框 -->
    <div class="login-register-item" v-if="isResetPassword">
        <!-- logo -->
        <svg fill="#FFFFFF" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="100px" height="100px">
            <path d="M 29.625 2 C 22.394531 2 18.871094 5.601563 17.734375 9.75 C 16.769531 8.769531 15.304688 8 13.167969 8 C 9.601563 8 6 10.085938 6 14.75 C 6 16.617188 7.105469 18.375 8.632813 19.308594 C 7.363281 20.242188 6 21.710938 6 24 C 6 25.527344 6.460938 26.714844 7.109375 27.621094 C 7.902344 27.226563 8.796875 27 9.75 27 C 10.582031 27 11.417969 27.136719 12.21875 27.402344 C 12.953125 27.136719 13.726563 27 14.5 27 C 15.359375 27 16.210938 27.160156 17 27.472656 C 17.789063 27.160156 18.640625 27 19.5 27 C 20.359375 27 21.210938 27.160156 22 27.472656 C 22.789063 27.160156 23.640625 27 24.5 27 C 25.359375 27 26.210938 27.160156 27 27.472656 C 27.789063 27.160156 28.640625 27 29.5 27 C 30.359375 27 31.210938 27.160156 32 27.472656 C 32.789063 27.160156 33.640625 27 34.5 27 C 35.273438 27 36.046875 27.136719 36.78125 27.402344 C 37.578125 27.136719 38.417969 27 39.25 27 C 40.5625 27 41.769531 27.429688 42.738281 28.140625 C 42.816406 28.054688 42.910156 27.9375 43.019531 27.777344 C 43.996094 26.351563 44 24.882813 44 24.25 C 44 21.117188 42.742188 19.292969 41.308594 18.464844 C 41.921875 16.59375 42 14.109375 42 13 C 42 6.316406 37.144531 2 29.625 2 Z M 17.5 16 C 18.882813 16 20 17.117188 20 18.5 C 20 19.882813 18.882813 21 17.5 21 C 16.117188 21 15 19.882813 15 18.5 C 15 17.117188 16.117188 16 17.5 16 Z M 33.5 16 C 34.882813 16 36 17.117188 36 18.5 C 36 19.882813 34.882813 21 33.5 21 C 32.117188 21 31 19.882813 31 18.5 C 31 17.117188 32.117188 16 33.5 16 Z M 18 17 C 17.449219 17 17 17.449219 17 18 C 17 18.550781 17.449219 19 18 19 C 18.550781 19 19 18.550781 19 18 C 19 17.449219 18.550781 17 18 17 Z M 34 17 C 33.449219 17 33 17.449219 33 18 C 33 18.550781 33.449219 19 34 19 C 34.550781 19 35 18.550781 35 18 C 35 17.449219 34.550781 17 34 17 Z M 23 21 L 28 21 C 28.550781 21 29 21.449219 29 22 C 29 23.65625 27.65625 25 26 25 L 25 25 C 23.34375 25 22 23.65625 22 22 C 22 21.449219 22.449219 21 23 21 Z M 9.75 29 C 7.683594 29 6 30.570313 6 32.5 C 6 32.589844 6.011719 32.679688 6.035156 32.765625 L 10.035156 47.265625 C 10.15625 47.699219 10.550781 48 11 48 L 38 48 C 38.449219 48 38.84375 47.699219 38.964844 47.265625 L 42.964844 32.765625 C 42.988281 32.679688 43 32.589844 43 32.5 C 43 30.570313 41.316406 29 39.25 29 C 38.332031 29 37.476563 29.222656 36.75 29.566406 C 36.082031 29.214844 35.316406 29 34.5 29 C 33.582031 29 32.71875 29.257813 32 29.695313 C 31.28125 29.257813 30.417969 29 29.5 29 C 28.582031 29 27.71875 29.257813 27 29.695313 C 26.28125 29.257813 25.417969 29 24.5 29 C 23.582031 29 22.71875 29.257813 22 29.695313 C 21.28125 29.257813 20.417969 29 19.5 29 C 18.582031 29 17.71875 29.257813 17 29.695313 C 16.28125 29.257813 15.417969 29 14.5 29 C 13.683594 29 12.917969 29.214844 12.25 29.566406 C 11.523438 29.222656 10.667969 29 9.75 29 Z M 9.75 31 C 11.066406 31 11.890625 31.5625 12.15625 31.886719 L 14.695313 46 L 11.761719 46 L 8.007813 32.386719 C 8.078125 31.621094 8.847656 31 9.75 31 Z M 19.5 31 C 20.703125 31 21.742188 31.761719 22 32.625 C 21.992188 32.625 22.46875 46 22.46875 46 L 18.640625 46 L 17.152344 32.378906 C 17.492188 31.625 18.414063 31 19.5 31 Z M 29.5 31 C 30.59375 31 31.515625 31.628906 31.855469 32.390625 L 30.410156 46 L 26.53125 46 C 26.53125 46 27.007813 32.625 27 32.625 C 27.253906 31.761719 28.289063 31 29.5 31 Z M 39.25 31 C 40.152344 31 40.921875 31.621094 40.996094 32.386719 L 37.238281 46 L 34.304688 46 L 36.839844 31.886719 C 37.105469 31.5625 37.933594 31 39.25 31 Z"/>
        </svg>
        <div class="login-name">Popcorn影视</div>

        <!-- 邮箱 新密码输入框 -->
        <input class="login-register-input" type="text" v-model="email" placeholder="请输入邮箱"/>
        <input class="login-register-input" type="password" v-model="newPassword" placeholder="请输入新密码"/>

        <!-- 验证码输入 + 按钮 -->
        <div class="code-wrapper">
            <input class="login-register-input code-input" type="text" v-model="code" placeholder="请输入验证码"/>
            <button @click="sendCode" class="get-code-btn" :disabled="isSendButton">{{ isSendButton ? countdown + '秒后重发'
                : '获取验证码' }}
            </button>
        </div>

        <!-- 重置按钮-->
        <button @click="resetPassword" class="auto-button" style="width: 70%; height: 50px; margin-top: 20px">重置密码</button>
    </div>

</div>
<script type="text/javascript">
    const app = new Vue({
        el: '#login-register-container',
        data: {
            telephone: "",
            email: "",
            password: "",
            code: "",
            account: "",
            loginPassword: "",
            newPassword:"",
            checked: false,
            isResetPassword: false,
            isRegister: false,  // 默认显示登录框
            isSendButton: false, // 发送验证码的按钮是否被点击
            countdown: 0 // 发送验证码的按钮的倒计时时间
        },
        methods: {
            loginChecked() {
                this.checked = !this.checked;
            },
            switchToRegister() {
                this.isRegister = true;
                this.isResetPassword = false;
            },
            switchToLogin() {
                this.isRegister = false;
                this.isResetPassword = false;
            },
            switchToReset() {
                this.isResetPassword = true;
            },
            // 正则表达式，判断手机号是否满足规则
            isValidTel(telNumber) {
                const telReg = /^1[3456789]\d{9}$/;
                return telReg.test(telNumber)
            },
            // 正则表达式，判断邮箱是否满足规则
            isValidEmail(email) {
                const emailReg = /^[\w.-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
                return emailReg.test(email);
            },

            sendCode() {
                if (!this.isValidEmail(this.email)) {
                    console.log(this.email)
                    this.$message.error("邮箱格式不正确")
                    return;
                }
                // 开始倒计时
                this.startCount();

                // 发送获取验证码的请求
                axios.get("/email/sendEmail?email=" + this.email).then(resp => {
                    if (1 === resp.data.code) {
                        this.$message.success("验证码已发送");
                    } else {
                        this.$message.warning(resp.data.msg);
                    }
                })
            },

            startCount() {
                // 禁用按钮
                this.isSendButton = true;
                // 设置倒计时为60s
                this.countdown = 60;
                // 每秒减少倒计时
                const timer = setInterval(() => {
                    if (this.countdown > 0) {
                        this.countdown -= 1;
                    } else {
                        this.isSendButton = false; // 将按钮置为未点击状态
                        clearInterval(timer); // 清除定时器
                    }
                }, 1000);
            },

            register() {
                if (!this.email || !this.password || !this.code || !this.telephone) {
                    this.$message.error("请填写所有注册信息");
                    return;
                }
                // 格式校验
                if (!this.isValidEmail(this.email)) {
                    this.$message.error("邮箱格式不正确");
                    return;
                }
                if (!this.isValidTel(this.telephone)) {
                    this.$message.error("手机号码格式不正确");
                    return;
                }

                // 点击注册按钮，发送注册请求
                axios.post("/admin/register", {
                    email: this.email,
                    tel: this.telephone,
                    password: this.password,
                    code: this.code
                }).then(resp => {
                    if (resp.data.code === 1) {
                        this.$message.success("注册成功，即将跳转到登录页面");
                        this.switchToLogin();
                    } else {
                        this.$message.error("resp.data.msg");
                    }
                }).catch(error => {
                    console.error("注册失败", error);
                    this.$message.error("注册失败，请稍后再试");
                })
            },

            resetPassword() {
                if (!this.email || !this.newPassword || !this.code) {
                    this.$message.error("请填写所有信息");
                    return;
                }
                // 格式校验
                if (!this.isValidEmail(this.email)) {
                    this.$message.error("邮箱格式不正确");
                    return;
                }
                // 点击重置按钮，发送重置请求
                axios.post("/admin/resetAdminPwd", {
                    email: this.email,
                    newPassword: this.newPassword,
                    code: this.code
                }).then(resp => {
                    if (resp.data.code === 1) {
                        this.$message.success("重置成功，即将跳转到登录页面");
                        this.switchToLogin();
                    } else {
                        this.$message.error(resp.data.msg);
                    }
                }).catch(error => {
                    console.error("重置失败", error);
                    this.$message.error("重置失败，请稍后再试");
                })
            },

            // 点击登录按钮，发送登录请求
            login() {
                if (!this.account || !this.loginPassword) {
                    this.$message.error("请填写账号和密码");
                    return;
                }

                let loginType = "";
                if (this.isValidEmail(this.account)) {
                    loginType = "email";
                } else if (this.isValidTel(this.account)) {
                    loginType = "tel";
                } else {
                    this.$message.error("请输入合法的邮箱或手机号");
                    return;
                }

                axios.post("/admin/login", {
                    account: this.account,
                    loginPassword: this.loginPassword,
                    type: loginType
                }).then(resp => {
                    if (0 == resp.data.code) {
                        this.$message.error("resp.data.msg");
                    } else {
                        console.log(resp.data.data)
                        // 使用localStorage存储登录状态(永久储存）
                        // 使用sessionStorage存储登录信息（一次回话存储）
                        sessionStorage.setItem("Authorization", resp.data.data);

                        // 跳转到首页
                        location.href = "main.html";
                    }
                }).catch(err => {
                    console.log("登录失败", err);
                    this.$message.error("登录失败，请重新输入账号密码");
                })
            },

        }
    })
</script>
</body>
</html>